# Terraform Project Structure & Modules Guide

## Overview

This Terraform project provisions an AWS EC2 Mac (M2) instance for red-teaming OpenAI's Atlas browser. The infrastructure is organized using modular design patterns for better maintainability, reusability, and clarity.

## Directory Structure

```
terraform/
├── main.tf                 # Root configuration - instantiates modules
├── variables.tf            # Root-level input variables
├── outputs.tf              # Root-level outputs
├── backend.tf              # S3 backend configuration with state locking
├── terraform.tfvars        # Default variable values
│
├── modules/                # Reusable infrastructure components
│   ├── networking/         # VPC, subnets, security groups, IGW
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   │
│   ├── iam/                # IAM roles and instance profiles
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   │
│   ├── ec2/                # EC2 instance, dedicated host, EIP
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   │
│   └── variables/          # Centralized variable definitions (reference only)
│       └── variables.tf
│
├── scripts/                # Utility scripts
│   └── vnc_setup.sh        # VNC server installation and configuration
│
├── docs/                   # Documentation
│   ├── README.md           # Quick start guide
│   └── DEPLOYMENT_CHECKLIST.md  # Step-by-step deployment guide
│
├── .gitignore              # Git ignore patterns
└── .terraform.lock.hcl     # Dependency lock file (generated by terraform init)
```

## Module Descriptions

### Networking Module (`modules/networking/`)

**Purpose**: Manages all networking infrastructure including VPC, subnets, security groups, and internet connectivity.

**Resources**:
- `aws_vpc` - Virtual Private Cloud
- `aws_subnet` - Public subnet for the EC2 instance
- `aws_internet_gateway` - Enables internet access
- `aws_route_table` - Routes traffic to IGW
- `aws_security_group` - Controls inbound/outbound traffic
- `aws_security_group_rule` - VNC access rules

**Inputs**:
- `vpc_cidr` - VPC CIDR block (default: `10.0.0.0/16`)
- `subnet_cidr` - Subnet CIDR block (default: `10.0.1.0/24`)
- `allowed_vnc_cidr` - IP range allowed for VNC (default: `0.0.0.0/0`)
- `enable_vnc` - Enable VNC ports (default: `true`)
- `tags` - Common resource tags

**Outputs**:
- `vpc_id` - VPC identifier
- `subnet_id` - Subnet identifier
- `security_group_id` - Security group identifier
- `internet_gateway_id` - IGW identifier
- `route_table_id` - Route table identifier

**Key Design Decisions**:
- SSH access is disabled - only Systems Manager and VNC access
- All outbound traffic is allowed
- VNC ports (5900, 6080) are configurable

### IAM Module (`modules/iam/`)

**Purpose**: Creates IAM roles and instance profiles for Systems Manager Session Manager access.

**Resources**:
- `aws_iam_role` - SSM access role
- `aws_iam_role_policy_attachment` - Attaches SSM managed policy
- `aws_iam_instance_profile` - Links role to EC2 instance

**Inputs**:
- `tags` - Common resource tags

**Outputs**:
- `iam_role_name` - Role name for reference
- `iam_role_arn` - Role ARN
- `instance_profile_name` - Instance profile name

**Key Design Decisions**:
- Uses AWS-managed policy `AmazonSSMManagedInstanceCore`
- No custom policies needed - minimal access model
- Instance profile allows role assumption by EC2 service

### EC2 Module (`modules/ec2/`)

**Purpose**: Provisions the Mac instance, dedicated host, and elastic IP.

**Resources**:
- `aws_ec2_host` - Dedicated Host (Mac2 required)
- `aws_instance` - EC2 Mac instance
- `aws_eip` - Elastic IP for stable public IP
- `aws_ami` (data source) - Latest Mac2 AMI lookup

**Inputs**:
- `instance_name` - Instance name tag
- `instance_type` - Instance type (default: `mac2.metal`)
- `iam_instance_profile_name` - IAM profile from IAM module
- `subnet_id` - Subnet from Networking module
- `security_group_id` - Security group from Networking module
- `enable_vnc` - Enable VNC setup
- `vnc_password` - VNC password (sensitive)
- `root_volume_size` - Volume size in GB (default: 250)
- `root_volume_type` - Volume type (default: `gp3`)
- `internet_gateway_id` - IGW for EIP dependency
- `tags` - Common resource tags

**Outputs**:
- `instance_id` - EC2 instance ID
- `instance_public_ip` - Elastic IP address
- `instance_private_ip` - Private IP address
- `instance_dns_name` - Public DNS name
- `dedicated_host_id` - Dedicated Host ID
- `eip_id` - Elastic IP ID
- `ami_id` - AMI ID used

**Key Design Decisions**:
- Mac2.metal requires dedicated host (cannot use on-demand)
- User data runs `scripts/vnc_setup.sh` for VNC configuration
- EIP ensures stable public IP across instance lifecycle
- 250GB gp3 volume for adequate workspace
- AMI lookup always gets latest Mac2 image

## Module Dependencies & Data Flow

```
root/main.tf
├── networking module
│   └── Outputs: vpc_id, subnet_id, sg_id, igw_id
│
├── iam module
│   └── Outputs: instance_profile_name
│
└── ec2 module
    ├── Depends on: networking outputs
    ├── Depends on: iam.instance_profile_name
    └── Outputs: instance_id, public_ip, etc.
```

## Variable Hierarchy

**Root Level** (`variables.tf`):
- All user-configurable variables defined here
- Grouped by category (AWS Config, Instance, Network, VNC, Storage, Tags)
- Sensitive variables (e.g., `vnc_password`) marked with `sensitive = true`

**Module Level**:
- Each module receives only needed variables via explicit passing in `main.tf`
- Prevents variable pollution and improves encapsulation
- Makes module dependencies clear and testable

## Adding/Modifying Modules

### To Add a New Module

1. Create new directory under `modules/`:
   ```bash
   mkdir -p modules/new_component
   ```

2. Create three files:
   - `main.tf` - Resource definitions
   - `variables.tf` - Input variable definitions
   - `outputs.tf` - Module outputs

3. Add module instantiation in root `main.tf`:
   ```hcl
   module "new_component" {
     source = "./modules/new_component"

     # Pass required variables
     variable1 = var.variable1
   }
   ```

4. Add output references in root `outputs.tf` if needed:
   ```hcl
   output "new_output" {
     value = module.new_component.output_name
   }
   ```

### To Modify a Module

1. Edit the module's `main.tf`, `variables.tf`, or `outputs.tf`
2. Update root `main.tf` if inputs/outputs change
3. Test with `terraform plan` before applying

## Sensitive Data Handling

- **VNC Password**: Stored in `terraform.tfvars` or environment variable
  - Set via: `export TF_VAR_vnc_password="password"`
  - Never commit actual passwords to git
  - .gitignore excludes `*.tfvars`

- **State File**: Stored in S3 with encryption
  - Encrypted at rest (AES256)
  - Versioning enabled for recovery
  - Native state locking (Terraform 1.10.0+)

## Deployment Workflow

1. **Initialize** → Sets up `.terraform/` directory and downloads modules
   ```bash
   terraform init
   ```

2. **Plan** → Reviews what will be created
   ```bash
   terraform plan
   ```

3. **Apply** → Creates all resources
   ```bash
   terraform apply
   ```

4. **Output** → Retrieves connection information
   ```bash
   terraform output connection_info
   ```

## Cost Considerations

- **Dedicated Host**: ~$1.90/hour (Mac2 in us-west-2)
- **EBS Volume**: ~$20/month (250GB gp3)
- **Data Transfer**: Minimal if using Systems Manager only
- **Total**: ~$150-200/month for 24/7 operation

**To minimize costs**: Use `terraform destroy` when not actively testing

## Troubleshooting

### Module Not Found Error
```
Error: Failed to download module

Ensure:
- Module paths are correct in main.tf (use `./modules/module_name`)
- Module directories exist with main.tf, variables.tf, outputs.tf
- Run: terraform init
```

### Variable Validation Error
```
Error: Invalid value for variable

Check:
- Variable types match in root variables.tf
- Default values are provided or set via environment variables
- Sensitive variables are set via TF_VAR_* or terraform.tfvars
```

### State Lock Issues
```
Error: Lock timeout

Solutions:
- Locks expire automatically after 5 minutes
- Force unlock only if you're certain no one else is working:
  terraform force-unlock <lock_id>
```

## Best Practices Implemented

✅ **Modularity**: Separate concerns into isolated modules
✅ **DRY Principle**: Centralized variable definitions at root level
✅ **Encapsulation**: Modules only receive needed variables
✅ **Documentation**: Clear descriptions on all variables and outputs
✅ **Tagging**: Consistent tagging across all resources
✅ **State Management**: S3 backend with encryption and locking
✅ **Security**: No hardcoded credentials, sensitive vars marked
✅ **Scalability**: Easy to extend with new modules or resources

## Related Documentation

- **Quick Start**: See `docs/README.md`
- **Deployment Steps**: See `docs/DEPLOYMENT_CHECKLIST.md`
- **Project Overview**: See `../CLAUDE.md` (parent directory)